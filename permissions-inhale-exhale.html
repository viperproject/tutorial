<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Inhaling and exhaling - Viper Tutorial</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Viper Tutorial</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="inhaling-and-exhaling"><a class="header" href="#inhaling-and-exhaling">Inhaling and Exhaling</a></h1>
<p>As previously mentioned, accessibility predicates in a method's precondition, such as <code>acc(x.f)</code> in the precondition of <code>inc</code>, can be understood as specifying that permission to a field (here <code>x.f</code>) must be transferred from caller to callee.
The process of gaining permission (which happens in the callee), is called <em>inhaling</em> permissions; the opposite process of losing permission (in the caller) is called <em>exhaling</em>. Both operations thus update the amount of currently held permissions: from a caller's perspective, permissions required by a precondition are removed before the call and permissions guaranteed by a postcondition are gained after the call returns. From a callee's perspective, the opposite happens.</p>
<p>Similar permission transfers also happen at other points in a Viper program; most notably, when verifying loops: a loop invariant specifies the permissions transferred (1) from the enclosing context to the first loop iteration, (2) from one loop iteration to the next, and (3) from the last loop iteration back to the enclosing context. Inside a loop body, heap locations may only be accessed if the required permissions have been explicitly transferred from the surrounding context to the loop body via the loop invariant.</p>
<p>In addition to specifying which permissions to transfer, Viper assertions may also specify constraints on values, just like in traditional specification languages. For example, a precondition <code>acc(x.f) &amp;&amp; x.f &gt; 0</code> requires permission to location <code>x.f</code> and that its value is positive. Note that the occurrence of <code>x.f</code> inside <code>acc(x.f)</code> denotes the <em>location</em> (in compiler parlance, <code>x.f</code> as an lvalue); the meaning of an accessibility predicate is independent of the value of <code>x.f</code> as an expression (as used, e.g., in <code>x.f &gt; 0</code>).</p>
<p>Consider now the call in the first line of method <code>client</code> in the example below: <code>set</code>'s precondition specifies that the permission to <code>a.f</code> is transferred from the caller to the callee, and that <code>i</code> must be greater than <code>a.f</code>. Thus, method <code>client</code> has to exhale the permission to <code>a.f</code> (which is inhaled by <code>set</code>) and the caller has to prove that <code>a.f &lt; i</code> (which it currently cannot). Conversely, the postcondition causes the permission to be transferred back to the caller when <code>set</code> terminates, i.e., it is inhaled by method <code>client</code>, and the caller gains the knowledge that <code>a.f == 5</code>.
When verifying method <code>set</code> itself, the opposite happens: permission to <code>x.f</code> is inhaled before the method body is verified, alongside the fact that <code>x.f &lt; i</code>. After the body has been verified, permission to <code>x.f</code> are exhaled and it is checked that <code>x.f</code>'s value is indeed <code>i</code>.</p>
<pre><code class="language-viper editable playground">field f: Int

method client(a: Ref)
  requires acc(a.f)
{
  set(a, 5)
  a.f := 6
}

method set(x: Ref, i: Int)
  requires acc(x.f) &amp;&amp; x.f &lt; i
  ensures  acc(x.f) &amp;&amp; x.f == i
{
  x.f := i
}
</code></pre>
<blockquote>
<p><strong>Exercise</strong></p>
<ul>
<li>Method <code>client</code> fails to verify: the precondition of the call <code>set(a, 5)</code> may not hold. Can you fix this (without modifying method <code>set</code>)?</li>
<li>Afterwards, add the following call as the last statement to method <code>client</code>: <code>set(a, a.f)</code>. Verification will now fail again. Remedy the situation by slightly weakening method <code>set</code>'s precondition.</li>
<li>Finally, comment out the postcondition of method <code>set</code>. Verification will fail again because method <code>client</code> does not have permission for the assignment to <code>a.f</code>. When a method call terminates, all remaining permissions that are not transferred back to its caller (via its postcondition) are <em>leaked</em> (lost).</li>
</ul>
</blockquote>
<p>Note that when encoding, e.g., a garbage-collected source language into Viper, the design choice that any excess permissions get leaked is convenient; it allows heap-based data to simply go out of scope and become unreachable. However, in the case of <code>set</code> in the example above, such leaking is presumably not the intention. Viper can also be used to check that certain permissions are <em>not</em> leaked; see the <code>perm</code> expression in the <a href="./expressions.html">section on expressions</a> for more details.</p>
<h2 id="inhale-and-exhale-statements"><a class="header" href="#inhale-and-exhale-statements">Inhale and Exhale Statements</a></h2>
<p>To enable the encoding of programming language features that are not directly supported by Viper, such as forking and joining threads or acquiring and releasing locks, Viper allows one to explicitly exhale or inhale permissions via the statements <code>exhale A</code> and <code>inhale A</code>, where <code>A</code> is a Viper assertion such as method <code>set</code>'s precondition <code>acc(x.f) &amp;&amp; i &lt; x.f</code>. From a caller's perspective, <code>set</code>'s pre- and postcondition can be seen as syntactic sugar for appropriate exhale and inhale statements before and after a call to the method.</p>
<p>The informal semantics of <code>exhale A</code> is as follows:</p>
<ol>
<li><em>Assert</em> that all value constraints in <code>A</code> hold; if not, verification fails</li>
<li><em>Assert</em> that all permissions denoted (via accessibility predicates) by <code>A</code> are currently held; if not, verification fails</li>
<li><em>Remove</em> the permissions denoted by <code>A</code></li>
</ol>
<p>The informal semantics of <code>inhale A</code> is as follows:</p>
<ol>
<li><em>Add</em> the permissions denoted by <code>A</code> to the program state</li>
<li><em>Assume</em> that all value constraints in <code>A</code> hold</li>
</ol>
<p>As an example, consider the following Viper program (ignoring, for the moment, the commented-out lines):</p>
<pre><code class="language-viper editable playground">field f: Int

method set_inex(x: Ref, i: Int) {
  // x.f := i
  inhale acc(x.f)
  x.f := i
  // exhale acc(x.f)
  // x.f := i
}
</code></pre>
<p>Unlike the previous example, this method has no pre- and postcondition (no <code>requires</code>/<code>ensures</code>). This means that we start verification of the method body in a state with no permissions. The statement <code>inhale acc(x.f)</code> causes the corresponding permission to be added to the state, allowing the assignment on the following line to verify.</p>
<blockquote>
<p><strong>Exercise</strong></p>
<ul>
<li>Uncomment the first line of the method body. This will cause a verification error (on that line) since we try to access the location <code>x.f</code> before inhaling the necessary permission.</li>
<li>Alternatively, uncomment the last two lines of the method body. This will cause a verification error for the last line, since we exhale the permission <code>x.f</code> before accessing the heap location.</li>
<li>Uncomment the exhale statement and duplicate it, i.e., attempt to exhale permission to <code>x.f</code> twice. What happens?</li>
</ul>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="permissions-state.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="permissions-self-framing.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="permissions-state.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="permissions-self-framing.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>

        <script src="ace.js"></script>
        <script src="mode-rust.js"></script>
        <script src="editor.js"></script>
        <script src="theme-dawn.js"></script>
        <script src="theme-tomorrow_night.js"></script>

        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="editor.js"></script>
        <script src="mode-viper.js"></script>


    </div>
    </body>
</html>
