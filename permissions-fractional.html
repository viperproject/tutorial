<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Fractional permissions - Viper Tutorial</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Viper Tutorial</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="fractional-permissions"><a class="header" href="#fractional-permissions">Fractional Permissions</a></h1>
<p>Exclusive permissions are too restrictive for some applications. For instance, it is typically safe for multiple threads of a source program to concurrently access the same heap location as long as all accesses are reads. That is, read access can safely be shared. However, if any thread potentially writes to a heap location, no other should typically be allowed to concurrently read it (otherwise, the program has a <em>data race</em>). To support encoding such scenarios, Viper also supports <em>fractional permissions</em> with a <em>permission amount</em> between 0 and 1. Any non-zero permission amount allows read access to the corresponding heap location, but only the exclusive permission (1) allows modifications.</p>
<p>The general form of an accessibility predicate for field permissions is <code>acc(e.f, p)</code>, where <code>e</code> is a <code>Ref</code>-typed expression, <code>f</code> is a field name, and <code>p</code> denotes a permission amount. Permission amounts are denoted by <code>write</code> for exclusive permissions, <code>none</code> for zero permission, quotients of two <code>Int</code>-typed expressions <code>i1/i2</code> to denote a fractional permission; any <code>Perm</code>-typed expression may be used here. <code>Perm</code> is the type of permission amounts, which is a built-in type that can be used like any other type. The permission amount parameter <code>p</code> is optional and defaults to <code>write</code>. For example, <code>acc(e.f)</code>, <code>acc(e.f, write)</code> and <code>acc(e.f, 1/1)</code> all have the same meaning.</p>
<p>The next example illustrates the usage of fractional permissions to distinguish between read and write access: there, method <code>copyAndInc</code> requires write permission to <code>x.f</code>, but only read permission (we arbitrarily chose <code>1/2</code>, but any non-zero fraction would suffice) to <code>y.f</code>.</p>
<pre><code class="language-viper editable playground">field f: Int

method copyAndInc(x: Ref, y: Ref)
  requires acc(x.f) &amp;&amp; acc(y.f, 1/2)
  ensures  acc(x.f) &amp;&amp; acc(y.f, 1/2)
{
  x.f := y.f + 1
}
</code></pre>
<blockquote>
<p><strong>Exercise</strong></p>
<ul>
<li>Change the permission amount for <code>x.f</code> to <code>9/10</code>, i.e., the corresponding accessibility predicates to <code>acc(x.f, 9/10)</code>. Where does the code fail (and why)?</li>
<li>Alternatively, change the implementation to <code>y.f := x.f + 1</code>.</li>
<li>Revert to the original example. Afterwards, change the permission amount for <code>y.f</code> to <code>none</code> (or <code>0/1</code>). Where does the code fail (and why)?</li>
</ul>
</blockquote>
<p>Fractional permissions to the same location are <em>summed up</em>: inhaling <code>acc(x.f, p1) &amp;&amp; acc(x.f, p2)</code> is equivalent to inhaling <code>acc(x.f, p1 + p2)</code>, and analogously for exhaling. As before, inhaling permissions maintains the invariant that write permission to a location are exclusive. With fractional permission in mind, this can be rephrased as maintaining the invariant that the permission amount to a location never exceeds 1.</p>
<p>To illustrate this, consider the next example (and its exercises): there, the <code>assert</code> statement fails because holding one third permission to each <code>x.f</code> and <code>y.f</code> does not imply that <code>x</code> and <code>y</code> cannot be aliases, since the sum of the individual permission amounts does not exceed 1.</p>
<pre><code class="language-viper editable playground">field f: Int

method test(x: Ref, y: Ref) {
  inhale acc(x.f, 1/2) &amp;&amp; acc(y.f, 1/2)
  assert x != y
}
</code></pre>
<blockquote>
<p><strong>Exercise</strong></p>
<ul>
<li>Change both permission amounts to <code>2/3</code>. The <code>assert</code> statement will now verify.</li>
<li>Revert to the original example. Afterwards, replace the <code>assert</code> statement by <code>inhale x == y</code> and add the statement <code>exhale acc(x.f, 1/1)</code> to the end of method <code>test</code>. The code verifies, which illustrates that permission amounts are summed up.</li>
<li>Revert to the original example. Afterwards, replace the <code>assert</code> statement by <code>exhale acc(x.f, 1/8) &amp;&amp; acc(x.f, 1/8)</code>, and add the subsequent statement <code>exhale acc(x.f, 1/4)</code>. The code verifies, which illustrates that permission amounts can be split up.</li>
<li>Revert to the original example. Afterwards, add a third argument <code>z: Ref</code> to the signature of method <code>test</code>, add the conjunct <code>acc(z.f, 1/2)</code> to the <code>inhale</code> statement and change the <code>assert</code> statement to <code>x != y || x != z</code>. This verifies , but neither disjunct on their own will. Why?</li>
</ul>
</blockquote>
<p>While fractional permissions no longer always guarantee non-aliasing between references, as demonstrated by the previous example, they still enable framing, e.g., across method calls: from a caller's perspective, holding on to a non-zero permission amount to a location <code>x.f</code> across a method call guarantees that the value of <code>x.f</code> cannot be affected by the call. That is, because the callee would need to obtain write permission, i.e., permission amount 1, which cannot happen as long as the caller retains its fraction.</p>
<p>The next example illustrates the use of fractional permissions for framing: there, method <code>client</code> can frame the property <code>b.f == 3</code> across the call to <code>copyAndInc</code> because <code>client</code> retains half the permission to <code>b.f</code> across the call. Note that the postcondition of <code>copyAndInc</code> does not explicitly state that the value of <code>y.f</code> remains unchanged.</p>
<pre><code class="language-viper editable playground">field f: Int

method copyAndInc(x: Ref, y: Ref)
  requires acc(x.f) &amp;&amp; acc(y.f, 1/2)
  ensures  acc(x.f) &amp;&amp; acc(y.f, 1/2)
  ensures  x.f == y.f + 1
{
  x.f := y.f + 1
}

method client(a: Ref, b: Ref) {
  inhale acc(a.f) &amp;&amp; acc(b.f)

  a.f := 1
  b.f := 3

  copyAndInc(a, b)

  assert b.f == 3 &amp;&amp; a.f == 4
}
</code></pre>
<blockquote>
<p><strong>Exercise</strong></p>
<ul>
<li>Add the statement <code>exhale acc(b.f, 1/2)</code> right before the invocation of <code>copyAndInc</code>. Since method <code>client</code> temporarily loses all permission to <code>b.f</code>, the property <code>b.f == 3</code> can no longer be framed across the call. Note that method <code>client</code> cannot deduce modularly (i.e., without considering the body of method <code>copyAndInc</code>) that <code>copyAndInc</code> does <em>not</em> modify <code>b.f</code>; the method body might inhale the other half permission (e.g., modelling the acquisition of a lock) and thus, be able to assign to <code>b.f</code>.</li>
<li>Can you fix the new code by changing the specifications of method <code>copyAndInc</code>?</li>
<li>Revert to the original example. Afterwards, modify method <code>client</code> as follows: change the invocation of method <code>copyAndInc</code> to <code>copyAndInc(a, a)</code>, and change the <code>assert</code> statement to <code>assert b.f == 3 &amp;&amp; a.f == 2</code>. To verify the resulting code, you'll have to change the specifications of method <code>copyAndInc</code>.</li>
<li>Can you find specifications for method <code>copyAndInc</code> that allow verifying both versions of method <code>client</code>: the original implementation (<code>copyAndInc(a, b); assert b.f == 3 &amp;&amp; a.f == 4</code>) and the new one (<code>copyAndInc(a, a); assert b.f == 3 &amp;&amp; a.f == 2</code>). That is, can you find specifications that work, regardless of whether or not the passed references are aliases?</li>
</ul>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="permissions-exclusive.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="predicates.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="permissions-exclusive.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="predicates.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>

        <script src="ace.js"></script>
        <script src="mode-rust.js"></script>
        <script src="editor.js"></script>
        <script src="theme-dawn.js"></script>
        <script src="theme-tomorrow_night.js"></script>

        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="editor.js"></script>
        <script src="mode-viper.js"></script>


    </div>
    </body>
</html>
